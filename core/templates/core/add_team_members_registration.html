{% extends 'base.html' %}

{% block title %}Add Team Members - ARTIFA FEST{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="card border-primary mb-4">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-users"></i> Add Team Members
                    </h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <strong>Team Lead:</strong> You are the team leader for this registration.
                        <br><strong>Only you can add, edit, or remove team members.</strong>
                    </div>

                    <!-- Registration Summary -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p><strong>Your Name:</strong> {{ registration.full_name }}</p>
                            <p><strong>Register Number:</strong> {{ registration.register_number }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Event:</strong> {{ event.name }}</p>
                            <p><strong>Team Name:</strong> {{ team_name }}</p>
                        </div>
                    </div>

                    <!-- Team Requirements -->
                    <div class="alert alert-warning">
                        <strong>Team Requirements:</strong>
                        <ul class="mb-0">
                            <li>Minimum members: <span class="badge bg-warning text-dark">{{ min_members }}</span></li>
                            <li>Maximum members: <span class="badge bg-warning text-dark">{{ max_members }}</span></li>
                            <li>Current members (including you): <span class="badge bg-info">{{ current_members }}</span></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Team Members Form -->
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user-plus"></i> Add Team Members
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" class="needs-validation" novalidate>
                        {% csrf_token %}

                        <!-- Member Count Input -->
                        <div class="mb-3">
                            <label for="memberCount" class="form-label">
                                <strong>Total Members Needed (including you):</strong>
                            </label>
                            <input 
                                type="number" 
                                id="memberCount" 
                                name="member_count" 
                                class="form-control form-control-lg" 
                                min="{{ min_members }}" 
                                max="{{ max_members }}"
                                required
                                value="{{ max_members }}"
                                onchange="updateMemberFields()"
                            >
                            <small class="form-text text-muted">
                                Enter total members (min: {{ min_members }}, max: {{ max_members }})
                            </small>
                        </div>

                        <!-- Dynamic Member Fields -->
                        <div id="memberFieldsContainer" class="mb-4">
                            <h6 class="mt-4 mb-3"><strong>Enter Team Member Details:</strong></h6>
                            <div id="memberFields"></div>
                        </div>

                        <!-- Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" name="add_members" class="btn btn-success btn-lg">
                                <i class="fas fa-check"></i> Add Team Members
                            </button>
                            <a href="{% url 'team_dashboard' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back to Dashboard
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Existing Team Members (if team already created) -->
            {% if team %}
            <div class="card mt-4 border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> Team Members List
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Register Number</th>
                                    <th>Name</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for member in team.member_set.all %}
                                <tr>
                                    <td>
                                        <span class="badge bg-primary">
                                            {{ member.participant.register_number }}
                                        </span>
                                    </td>
                                    <td>{{ member.participant.full_name }}</td>
                                    <td>
                                        {% if member.status == 'joined' %}
                                            <span class="badge bg-success">Joined</span>
                                        {% elif member.status == 'pending' %}
                                            <span class="badge bg-warning text-dark">Pending</span>
                                        {% else %}
                                            <span class="badge bg-danger">Declined</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if registration.user == request.user %}
                                            {% if member.registration != registration %}
                                            <form method="POST" action="{% url 'remove_team_member' team.id member.id %}" style="display: inline;">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-danger" title="Remove member">
                                                    <i class="fas fa-trash"></i> Remove
                                                </button>
                                            </form>
                                            {% else %}
                                            <span class="badge bg-primary">Team Lead</span>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- View Team Details Link -->
                    <div class="mt-3">
                        <a href="{% url 'view_team' team.id %}" class="btn btn-info">
                            <i class="fas fa-eye"></i> View Full Team Details
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Instructions Card -->
            <div class="card mt-4 border-secondary">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle"></i> Instructions
                    </h5>
                </div>
                <div class="card-body">
                    <ol>
                        <li>Enter the total number of team members needed (including yourself)</li>
                        <li>Provide the register numbers of team members</li>
                        <li>Click "Add Team Members" to send invitations</li>
                        <li>Members will appear in the Team Members List above</li>
                        <li><strong>Only you (as team lead) can remove members</strong></li>
                        <li>Other members can accept or decline the invitation</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for dynamic member fields -->
<script>
function updateMemberFields() {
    const memberCount = parseInt(document.getElementById('memberCount').value) || 0;
    const container = document.getElementById('memberFields');
    container.innerHTML = '';

    // Subtract 1 because user is already a member
    const additionalMembers = memberCount - 1;

    for (let i = 1; i <= additionalMembers; i++) {
        const fieldHTML = `
            <div class="mb-3">
                <label for="memberRegister${i}" class="form-label">
                    Member ${i} Register Number:
                </label>
                <input 
                    type="text" 
                    id="memberRegister${i}" 
                    name="member_register_${i}" 
                    class="form-control" 
                    placeholder="e.g., 21AID001"
                    pattern="[0-9A-Za-z]+"
                >
            </div>
        `;
        container.innerHTML += fieldHTML;
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateMemberFields();
});

// Bootstrap form validation
(function () {
    'use strict';
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });
})();
</script>

<style>
    .card {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
    }

    .card-header {
        border-radius: 8px 8px 0 0;
        padding: 1.25rem;
    }

    .badge {
        font-size: 0.875rem;
        padding: 0.5rem 0.75rem;
    }

    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
    }

    .table {
        margin-bottom: 0;
    }

    .alert {
        border-radius: 6px;
    }
</style>
{% endblock %}
